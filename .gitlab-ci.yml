stages:
  - build
  - release

variables:
  GO_VERSION: "1.22.2"       # 使っている Go のバージョン
  BINARY_NAME: "kvtool"    # 実際のコマンド名に合わせて変更

# タグが push されたときだけビルド
build:
  stage: build
  image: golang:${GO_VERSION}
  # rules:
  #   - if: $CI_COMMIT_TAG
  script:
    - go version
    - make test
    - make build-full
  artifacts:
    paths:
      - dist/
    expire_in: 1 week

release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  needs:
    - job: build
      artifacts: true
  rules:
    - if: $CI_COMMIT_TAG   # タグのときだけ
  script:
    - echo "Creating GitLab Release for $CI_COMMIT_TAG"
    - |
      # dist/ 以下のファイルを列挙して --assets-link を組み立てる
      assets_links=""
      for f in dist/*; do
        fname=$(basename "$f")

        # artifacts への URL を組み立て
        url="$CI_PROJECT_URL/-/jobs/artifacts/$CI_COMMIT_TAG/raw/dist/$fname?job=build"

        # link_type は省略可だが、とりあえず "other" にしておく
        json=$(printf '{"name":"%s","url":"%s","link_type":"other"}' "$fname" "$url")

        # --assets-link=<json> をどんどん追加
        assets_links="$assets_links --assets-link=$json"
      done

      set -x
      release-cli create \
        --name "kvtool $CI_COMMIT_TAG" \
        --tag-name "$CI_COMMIT_TAG" \
        --description "Automated release for $CI_COMMIT_TAG" \
        $assets_links